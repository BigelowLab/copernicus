---
title: "copernicus"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# copernicus

Provides download, archiving and access to [Copernicus](https://marine.copernicus.eu/) marine local datasets using R language.

### Requirements

  + [R v4+](https://www.r-project.org/)
  + [rlang](https://CRAN.R-project.org/package=rlang)
  + [dplyr](https://CRAN.R-project.org/package=dplyr)
  + [ncdf4](https://CRAN.R-project.org/package=ncdf4)
  + [sf](https://CRAN.R-project.org/package=sf)
  + [stars](https://CRAN.R-project.org/package=stars)
  + [readr](https://CRAN.R-project.org/package=readr)
  + [twinkle](https://github.com/BigelowLab/twinkle)
  

### Installation

```
remotes::install_github("BigelowLab/copernicus")
```


### Configuration

You can preconfigure a credentials file (required) and a path definition file (optional) to streamline accessing and storing data.

#### Configure credentials

You must have credentials to access Copernicus holdings - if you don't have them now please request access [here](https://data.marine.copernicus.eu/register). 

Once you have them you can add them to a file hidden in your home directory. The functions in this package the require the credentials know where to look for them.  We don't actually run this in the README, but you can copy-and-paste to use in R.

```
library(copernicus)
set_credentials("username:password")
```

#### Configure data path

If you plan to use our directory-driven database storage system then you should set the root path for the data directory.  You can always change or override it, but, like credentials, storing this path in a hidden file will ease subsequent use of the functions. We don't actually run this in the README, but you can copy-and-paste to use in R.

```
set_root_path("/the/path/to/copernicus/data")
```


## Downloading data

You don't need to download data unless you need to download areas outside of `nwa` `[-77.0, -42.5,  36.5,  56.7]` See the [wiki](https://github.com/BigelowLab/copernicus/wiki/Downloading) for hints.

## Local dataset

We maintain a local dataset for the Northwest Atlantic (`nwa` `[-77.0, -42.5,  36.5,  56.7]`).  In particular we have the [GLOBAL_ANALYSIS_FORECAST_PHY_001_024](https://resources.marine.copernicus.eu/?option=com_csw&view=details&product_id=GLOBAL_ANALYSIS_FORECAST_PHY_001_024) for 10 surface water variables and bottom temp going back to January 1, 2019.

### Path

```{r path, message = FALSE}
library(dplyr)
library(stars)
library(copernicus)
dataset <- "global-analysis-forecast-phy-001-024"
path <- copernicus::copernicus_path(dataset, "nwa")
```

### Database

The database is very light, just date variable and depth. Depth recorded this way will allow for intermediate depths and depths ranges ('50' or '50-100').

```{r database, message = FALSE}
db <- copernicus::read_database(path)
db
```

### Look Up Table (lut)

The variable names are a bit cryptic (at least to me) so we provide a look-up table that associates the variable name with other information available from the source.

```{r lut, message = FALSE}
lut <- copernicus::read_lut(name = dataset)
print(lut, n = nrow(lut))
```

### Filenames

Filenames can be made with the database and the path.

```{r filenames, message = FALSE}

small_db <- db %>%
  dplyr::filter(var == 'so' & between(date, as.Date("2019-07-01"), as.Date("2019-07-06")))
filenames <- copernicus::compose_filename(small_db, path)
filenames
```

### Read timeseries of one variable

The [stars](https://r-spatial.github.io/stars/) package provides nice input utilities.  We have selected above just one variable for 6 days. So, it would be nice to have just one attribute with 6 bands.

```{r read_one_var, message = FALSE}
x <- stars::read_stars(filenames, along = 'time') %>%
  stars::st_set_dimensions(which = 'time', value = small_db$date)
plot(x)
```

### Read a day of multiple variables

Let select another subset of multiple variables for just one day (we could do multiple variables for multiple days, but, really, this is just a demo.) In this case we want multiple attributes (variables). [stars](https://r-spatial.github.io/stars/) will do that right out of the box.

```{r read_multi_variable, message = FALSE}
ice_db <- db %>% 
  dplyr::filter(var %in% c('usi', 'vsi', 'siconc', 'sithick') & 
                date == as.Date("2019-12-18"))
y <- ice_db %>%
  copernicus::compose_filename(path) %>%
  stars::read_stars() %>%
  setNames(ice_db$var)
plot(y['siconc'], main = 'siconc', axes = TRUE)
plot(y['sithick'], main = 'sithick', axes = TRUE)
```
